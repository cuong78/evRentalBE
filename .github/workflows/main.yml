name: CI/CD Pipeline - EVRental Backend

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng tá»« GitHub UI

env:
  DOCKER_IMAGE_NAME: evrental-backend
  JAVA_VERSION: '21'

jobs:
  # ==================== BUILD & TEST ====================
  build-and-test:
    name: ğŸ”¨ Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ”§ Clean and compile
        run: mvn clean compile

      - name: ğŸ§ª Run tests
        run: mvn test
        continue-on-error: true

      - name: ğŸ“¦ Package application
        run: mvn package -DskipTests

      - name: ğŸ“Š Test Report
        if: always()
        run: |
          if [ -d "target/surefire-reports" ]; then
            echo "âœ… Tests completed"
            find target/surefire-reports -name "*.xml" -exec cat {} \;
          fi

  # ==================== BUILD & PUSH DOCKER IMAGE ====================
  docker-build-push:
    name: ğŸ³ Build and Push Docker Image
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: ğŸ“ Generate Docker tags
        id: meta
        run: |
          echo "tags=${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest,${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "version=${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          dockerfile: Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:v${{ github.run_number }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:buildcache,mode=max

      - name: âœ… Image built successfully
        run: |
          echo "ğŸ‰ Docker image pushed successfully!"
          echo "ğŸ“¦ Image: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest"
          echo "ğŸ·ï¸ Version: v${{ github.run_number }}"

  # ==================== DEPLOY TO SERVER ====================
  deploy-to-server:
    name: ğŸš€ Deploy to Production Server
    needs: docker-build-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¤ Copy docker-compose to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "docker-compose.yml"
          target: "/opt/evrental"

      - name: ğŸš€ Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            
            echo "ğŸ¯ Starting deployment..."
            
            # Di chuyá»ƒn Ä‘áº¿n thÆ° má»¥c dá»± Ã¡n
            cd /opt/evrental || exit 1
            
            # Táº¡o backup cá»§a container cÅ© (náº¿u cÃ³)
            if docker ps -a | grep -q evrental-app; then
              echo "ğŸ’¾ Creating backup of old container..."
              docker commit evrental-app evrental-app-backup-$(date +%Y%m%d-%H%M%S) || true
            fi
            
            # Pull Docker image má»›i nháº¥t
            echo "ğŸ³ Pulling latest Docker image..."
            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
            
            # Cáº­p nháº­t docker-compose.yml vá»›i image name Ä‘Ãºng
            sed -i 's|build:|# build:|g' docker-compose.yml
            sed -i 's|context: .|# context: .|g' docker-compose.yml
            sed -i 's|dockerfile: Dockerfile|# dockerfile: Dockerfile|g' docker-compose.yml
            
            # ThÃªm image vÃ o docker-compose náº¿u chÆ°a cÃ³
            if ! grep -q "image:" docker-compose.yml; then
              sed -i '/container_name: evrental-app/a\    image: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest' docker-compose.yml
            fi
            
            # Dá»«ng vÃ  xÃ³a container cÅ©
            echo "ğŸ›‘ Stopping old containers..."
            docker-compose down
            
            # Khá»Ÿi Ä‘á»™ng láº¡i vá»›i image má»›i
            echo "ğŸš€ Starting new containers..."
            docker-compose up -d
            
            # Äá»£i container khá»Ÿi Ä‘á»™ng
            echo "â³ Waiting for containers to be healthy..."
            sleep 15
            
            # Kiá»ƒm tra tráº¡ng thÃ¡i
            echo "ğŸ“Š Container status:"
            docker-compose ps
            
            # Kiá»ƒm tra logs
            echo "ğŸ“‹ Recent logs:"
            docker-compose logs --tail=30 app
            
            # Dá»n dáº¹p images cÅ© (giá»¯ láº¡i 3 images gáº§n nháº¥t)
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=72h" || true
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application version: v${{ github.run_number }}"

  # ==================== HEALTH CHECK ====================
  health-check:
    name: ğŸ¥ Health Check
    needs: deploy-to-server
    runs-on: ubuntu-latest

    steps:
      - name: â³ Wait for service to start
        run: sleep 30

      - name: ğŸ” Check application health
        run: |
          echo "ğŸ¥ Checking application health..."
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8080/actuator/health || echo "000")
            
            if [ "$RESPONSE" = "200" ]; then
              echo "âœ… Application is healthy! (HTTP $RESPONSE)"
              exit 0
            else
              echo "âš ï¸ Health check attempt $((RETRY_COUNT + 1))/$MAX_RETRIES failed (HTTP $RESPONSE)"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep 10
            fi
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1
        continue-on-error: true

      - name: ğŸ“¢ Deployment notification
        if: always()
        run: |
          echo "ğŸ‰ Deployment pipeline completed!"
          echo "ğŸ“¦ Version: v${{ github.run_number }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"