# üöÄ H∆∞·ªõng D·∫´n Deploy EVRental Backend L√™n Server

> **D√†nh cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu - H∆∞·ªõng d·∫´n t·ª´ng b∆∞·ªõc chi ti·∫øt**

## üìã M·ª•c L·ª•c
1. [Chu·∫©n b·ªã](#1-chu·∫©n-b·ªã)
2. [Thu√™ v√† setup VPS](#2-thu√™-v√†-setup-vps)
3. [C√†i ƒë·∫∑t Docker tr√™n server](#3-c√†i-ƒë·∫∑t-docker-tr√™n-server)
4. [Setup GitHub Secrets](#4-setup-github-secrets)
5. [C·∫•u h√¨nh server](#5-c·∫•u-h√¨nh-server)
6. [Deploy l·∫ßn ƒë·∫ßu](#6-deploy-l·∫ßn-ƒë·∫ßu)
7. [Ki·ªÉm tra v√† monitoring](#7-ki·ªÉm-tra-v√†-monitoring)
8. [Troubleshooting](#8-troubleshooting)

---

## 1. Chu·∫©n B·ªã

### ‚úÖ Checklist tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu:

- [ ] T√†i kho·∫£n GitHub (ƒë√£ c√≥)
- [ ] T√†i kho·∫£n Docker Hub (mi·ªÖn ph√≠)
- [ ] VPS/Server (khuy·∫øn ngh·ªã: DigitalOcean, Vultr, ho·∫∑c AWS)
- [ ] Domain (t√πy ch·ªçn, c√≥ th·ªÉ d√πng IP)

### üí∞ Chi ph√≠ ∆∞·ªõc t√≠nh:

- **VPS**: $5-10/th√°ng (2GB RAM, 1 CPU)
- **Domain**: $10-15/nƒÉm (t√πy ch·ªçn)
- **Docker Hub**: Mi·ªÖn ph√≠
- **GitHub Actions**: Mi·ªÖn ph√≠ (2000 ph√∫t/th√°ng)

---

## 2. Thu√™ v√† Setup VPS

### Option 1: DigitalOcean (Khuy·∫øn ngh·ªã cho ng∆∞·ªùi m·ªõi)

1. **ƒêƒÉng k√Ω t√†i kho·∫£n:**
   - Truy c·∫≠p: https://www.digitalocean.com
   - ƒêƒÉng k√Ω v·ªõi email
   - Nh·∫≠n $200 credit mi·ªÖn ph√≠ (60 ng√†y)

2. **T·∫°o Droplet (VPS):**
   ```
   Click "Create" ‚Üí "Droplets"
   
   Choose an image:
   ‚úÖ Ubuntu 22.04 LTS x64
   
   Choose size:
   ‚úÖ Basic Plan - $6/month
      - 1 CPU
      - 2GB RAM
      - 50GB SSD
   
   Choose datacenter region:
   ‚úÖ Singapore (g·∫ßn Vi·ªát Nam nh·∫•t)
   
   Authentication:
   ‚úÖ SSH Key (AN TO√ÄN H∆†N) - Xem b∆∞·ªõc 2.1
   ho·∫∑c
   ‚ö†Ô∏è Password (ƒë∆°n gi·∫£n h∆°n)
   
   Hostname:
   ‚úÖ evrental-backend
   
   Click "Create Droplet"
   ```

3. **L∆∞u l·∫°i th√¥ng tin:**
   ```
   IP Address: 123.456.789.10 (v√≠ d·ª•)
   Username: root
   Password/SSH Key: (ƒë√£ t·∫°o ·ªü b∆∞·ªõc tr√™n)
   ```

### 2.1. T·∫°o SSH Key (QUAN TR·ªåNG - AN TO√ÄN)

**Windows (Git Bash):**
```bash
# M·ªü Git Bash
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# Nh·∫•n Enter 3 l·∫ßn (ƒë·ªÉ m·∫∑c ƒë·ªãnh)
# File s·∫Ω ƒë∆∞·ª£c t·∫°o t·∫°i: C:\Users\YourName\.ssh\id_rsa

# Xem n·ªôi dung public key
cat ~/.ssh/id_rsa.pub

# Copy to√†n b·ªô n·ªôi dung (b·∫Øt ƒë·∫ßu v·ªõi ssh-rsa...)
```

**Paste v√†o DigitalOcean khi t·∫°o Droplet:**
- Click "New SSH Key"
- Paste n·ªôi dung `id_rsa.pub`
- ƒê·∫∑t t√™n: "My Laptop"

### Option 2: Vultr (R·∫ª h∆°n)

Similar steps, gi√° t·ª´ $3.5/th√°ng

### Option 3: AWS EC2 (Ph·ª©c t·∫°p h∆°n nh∆∞ng m·∫°nh)

Free tier 12 th√°ng ƒë·∫ßu (gi·ªõi h·∫°n 750 gi·ªù/th√°ng)

---

## 3. C√†i ƒê·∫∑t Docker Tr√™n Server

### 3.1. K·∫øt n·ªëi v√†o server

**Windows (Git Bash ho·∫∑c PowerShell):**
```bash
# N·∫øu d√πng SSH Key
ssh root@123.456.789.10

# N·∫øu d√πng Password
ssh root@123.456.789.10
# Nh·∫≠p password khi ƒë∆∞·ª£c h·ªèi

# L·∫ßn ƒë·∫ßu s·∫Ω h·ªèi "Are you sure...?" ‚Üí g√µ "yes"
```

### 3.2. Update h·ªá th·ªëng

```bash
# Update package list
sudo apt update && sudo apt upgrade -y

# C√†i ƒë·∫∑t c√°c package c·∫ßn thi·∫øt
sudo apt install -y curl git wget nano
```

### 3.3. C√†i ƒë·∫∑t Docker

```bash
# X√≥a Docker c≈© (n·∫øu c√≥)
sudo apt remove docker docker-engine docker.io containerd runc

# C√†i ƒë·∫∑t Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Th√™m user v√†o docker group (kh√¥ng c·∫ßn sudo)
sudo usermod -aG docker $USER

# Kh·ªüi ƒë·ªông Docker
sudo systemctl enable docker
sudo systemctl start docker

# Ki·ªÉm tra
docker --version
# K·∫øt qu·∫£: Docker version 24.x.x
```

### 3.4. C√†i ƒë·∫∑t Docker Compose

```bash
# C√†i ƒë·∫∑t Docker Compose
sudo apt install -y docker-compose-plugin

# Ki·ªÉm tra
docker compose version
# K·∫øt qu·∫£: Docker Compose version v2.x.x
```

### 3.5. Ki·ªÉm tra c√†i ƒë·∫∑t

```bash
# Test Docker
docker run hello-world

# N·∫øu th·∫•y "Hello from Docker!" ‚Üí SUCCESS! ‚úÖ
```

---

## 4. Setup GitHub Secrets

### 4.1. T·∫°o Docker Hub Token

1. ƒêƒÉng nh·∫≠p https://hub.docker.com
2. Click avatar ‚Üí **Account Settings**
3. **Security** ‚Üí **New Access Token**
4. Token description: `GitHub Actions`
5. Access permissions: **Read, Write, Delete**
6. Click **Generate**
7. **COPY TOKEN NGAY** (ch·ªâ hi·ªán 1 l·∫ßn!)

### 4.2. T·∫°o SSH Key cho GitHub Actions

**Tr√™n server (ƒë√£ SSH v√†o):**
```bash
# T·∫°o SSH key m·ªõi cho GitHub Actions
ssh-keygen -t rsa -b 4096 -f ~/.ssh/github_actions_key

# Nh·∫•n Enter 2 l·∫ßn (kh√¥ng c·∫ßn passphrase)

# Th√™m public key v√†o authorized_keys
cat ~/.ssh/github_actions_key.pub >> ~/.ssh/authorized_keys

# Xem private key (COPY to√†n b·ªô)
cat ~/.ssh/github_actions_key
# K·∫øt qu·∫£:
# -----BEGIN OPENSSH PRIVATE KEY-----
# b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAACFwAAAAdzc2gtcn
# ... (nhi·ªÅu d√≤ng)
# -----END OPENSSH PRIVATE KEY-----
```

### 4.3. Th√™m Secrets v√†o GitHub

1. M·ªü repository: https://github.com/cuong78/evRentalBE
2. **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**
3. Click **New repository secret**

**Th√™m t·ª´ng secret sau:**

| Secret Name | Value | V√≠ d·ª• |
|------------|-------|-------|
| `DOCKER_HUB_USERNAME` | Username Docker Hub c·ªßa b·∫°n | `anhcuong8386` |
| `DOCKER_HUB_ACCESS_TOKEN` | Token v·ª´a t·∫°o ·ªü b∆∞·ªõc 4.1 | `dckr_pat_xxxxx...` |
| `SERVER_HOST` | IP c·ªßa VPS | `123.456.789.10` |
| `SERVER_USER` | Username SSH | `root` |
| `SERVER_SSH_KEY` | Private key t·ª´ b∆∞·ªõc 4.2 | `-----BEGIN OPENSSH...` |
| `SERVER_PORT` | Port SSH (m·∫∑c ƒë·ªãnh) | `22` |

**Screenshot h∆∞·ªõng d·∫´n:**
```
GitHub Repo ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
‚Üí New repository secret
‚Üí Name: DOCKER_HUB_USERNAME
‚Üí Secret: anhcuong8386
‚Üí Add secret
```

---

## 5. C·∫•u H√¨nh Server

### 5.1. T·∫°o c·∫•u tr√∫c th∆∞ m·ª•c

```bash
# SSH v√†o server
ssh root@YOUR_SERVER_IP

# T·∫°o th∆∞ m·ª•c d·ª± √°n
sudo mkdir -p /opt/evrental
cd /opt/evrental

# Set quy·ªÅn
sudo chown -R $USER:$USER /opt/evrental
```

### 5.2. T·∫°o file .env

```bash
# T·∫°o file .env
nano /opt/evrental/.env
```

**Paste n·ªôi dung sau (CH√ö √ù: THAY ƒê·ªîI C√ÅC GI√Å TR·ªä):**

```env
# ==================== DATABASE ====================
SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/evrental
SPRING_DATASOURCE_USERNAME=postgres
SPRING_DATASOURCE_PASSWORD=ChangeMe_SecurePassword123!

POSTGRES_DB=evrental
POSTGRES_USER=postgres
POSTGRES_PASSWORD=ChangeMe_SecurePassword123!

# ==================== JWT ====================
JWT_SECRET=ChangeMe_YourSuperSecretJWTKey_MinLength32Characters_Random123!
JWT_EXPIRATION_MS=3600000
JWT_REFRESH_EXPIRATION_MS=86400000

# ==================== EMAIL ====================
SPRING_MAIL_HOST=smtp.gmail.com
SPRING_MAIL_PORT=587
SPRING_MAIL_USERNAME=your-email@gmail.com
SPRING_MAIL_PASSWORD=your-app-password-here

# ==================== FRONTEND URLs ====================
# Thay YOUR_DOMAIN b·∫±ng domain/IP th·ª±c t·∫ø
FRONTEND_URL_BASE=http://YOUR_DOMAIN:3000
FRONTEND_URL_PAYMENT_RETURN=http://YOUR_DOMAIN:3000/payment/vnpay-return
FRONTEND_URL_EMAIL_VERIFICATION=http://YOUR_DOMAIN:3000/verify-email

# ==================== VNPAY ====================
PAYMENT_VNPAY_TMN_CODE=F9EZ1X6Z
PAYMENT_VNPAY_SECRET_KEY=XV3C5IN6HACS0NWN5OHG1IDLYOZWI1VX
PAYMENT_VNPAY_URL=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
PAYMENT_VNPAY_IP_ADDRESS=127.0.0.1
PAYMENT_VNPAY_WALLET_RETURN_URL=http://YOUR_DOMAIN:8080/api/v1/payment/wallet/return

# ==================== CLOUDINARY ====================
CLOUDINARY_CLOUD_NAME=duklfdbqf
CLOUDINARY_API_KEY=896897124846695
CLOUDINARY_API_SECRET=OPLZ7KB09RIZZXJlN7Im8w75w9k

# ==================== SERVER ====================
SERVER_PORT=8080
TZ=Asia/Ho_Chi_Minh
```

**L∆∞u file:**
- Nh·∫•n `Ctrl + X`
- Nh·∫•n `Y`
- Nh·∫•n `Enter`

### 5.3. B·∫£o m·∫≠t file .env

```bash
# Ch·ªâ owner m·ªõi ƒë·ªçc ƒë∆∞·ª£c
chmod 600 /opt/evrental/.env

# Ki·ªÉm tra
ls -la /opt/evrental/.env
# K·∫øt qu·∫£: -rw------- 1 root root ... .env
```

### 5.4. T·∫°o file docker-compose.yml t·∫°m th·ªùi

```bash
# T·∫°o file docker-compose.yml (s·∫Ω ƒë∆∞·ª£c GitHub Actions overwrite)
nano /opt/evrental/docker-compose.yml
```

**Paste n·ªôi dung:**
```yaml
version: '3.8'

services:
  postgres:
    container_name: evrental-postgres
    image: postgres:17.5
    restart: unless-stopped
    env_file: .env
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - evrental-network

  app:
    container_name: evrental-app
    image: anhcuong8386/evrental-backend:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
    env_file: .env
    depends_on:
      - postgres
    networks:
      - evrental-network

networks:
  evrental-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
```

**L∆∞u file:** `Ctrl + X` ‚Üí `Y` ‚Üí `Enter`

---

## 6. Deploy L·∫ßn ƒê·∫ßu

### 6.1. C·∫≠p nh·∫≠t docker-compose.yml trong d·ª± √°n

**S·ª≠a file `docker-compose.yml` trong d·ª± √°n:**

```yaml
version: '3.8'

services:
  postgres:
    container_name: evrental-postgres
    image: postgres:17.5
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      TZ: Asia/Ho_Chi_Minh
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - evrental-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d evrental"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    container_name: evrental-app
    # build:              # ‚Üê Comment out khi deploy
    #   context: .
    #   dockerfile: Dockerfile
    image: anhcuong8386/evrental-backend:latest  # ‚Üê Th√™m d√≤ng n√†y
    restart: unless-stopped
    ports:
      - "8080:8080"
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - evrental-network

networks:
  evrental-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
```

### 6.2. Push code l√™n GitHub

```bash
# Tr√™n m√°y local
git add .
git commit -m "Setup CI/CD pipeline"
git push origin main
```

### 6.3. Theo d√µi deployment

1. M·ªü GitHub: https://github.com/cuong78/evRentalBE
2. Click tab **Actions**
3. Xem workflow ƒëang ch·∫°y
4. Click v√†o workflow ƒë·ªÉ xem chi ti·∫øt t·ª´ng b∆∞·ªõc

**Th·ªùi gian ∆∞·ªõc t√≠nh:**
- Build & Test: ~3-5 ph√∫t
- Docker Build & Push: ~5-7 ph√∫t
- Deploy to Server: ~2-3 ph√∫t
- **T·ªïng: ~10-15 ph√∫t**

### 6.4. Ki·ªÉm tra tr√™n server

```bash
# SSH v√†o server
ssh root@YOUR_SERVER_IP

# Ki·ªÉm tra containers
cd /opt/evrental
docker compose ps

# K·∫øt qu·∫£ mong ƒë·ª£i:
# NAME                 STATUS              PORTS
# evrental-postgres    Up 5 minutes        0.0.0.0:5432->5432/tcp
# evrental-app         Up 2 minutes        0.0.0.0:8080->8080/tcp

# Xem logs
docker compose logs -f app

# Nh·∫•n Ctrl+C ƒë·ªÉ tho√°t
```

---

## 7. Ki·ªÉm Tra v√† Monitoring

### 7.1. Test API

```bash
# Test health check
curl http://YOUR_SERVER_IP:8080/actuator/health

# K·∫øt qu·∫£ mong ƒë·ª£i:
# {"status":"UP"}

# Test API endpoint (v√≠ d·ª•)
curl http://YOUR_SERVER_IP:8080/api/v1/vehicles

# Ho·∫∑c m·ªü tr√¨nh duy·ªát:
http://YOUR_SERVER_IP:8080/actuator/health
```

### 7.2. Xem logs real-time

```bash
# Logs c·ªßa app
docker compose logs -f app

# Logs c·ªßa database
docker compose logs -f postgres

# Logs c·ªßa t·∫•t c·∫£ services
docker compose logs -f
```

### 7.3. Monitoring script

T·∫°o script ƒë·ªÉ check health:

```bash
nano /opt/evrental/health-check.sh
```

Paste:
```bash
#!/bin/bash

echo "üè• EVRental Backend Health Check"
echo "================================="

# Check containers
echo ""
echo "üì¶ Container Status:"
docker compose ps

# Check health endpoint
echo ""
echo "üîç Health Endpoint:"
curl -s http://localhost:8080/actuator/health | jq '.'

# Check disk space
echo ""
echo "üíæ Disk Space:"
df -h /

# Check memory
echo ""
echo "üß† Memory Usage:"
free -h

# Check recent logs
echo ""
echo "üìã Recent Logs (last 20 lines):"
docker compose logs --tail=20 app
```

Ch·∫°y:
```bash
chmod +x /opt/evrental/health-check.sh
./health-check.sh
```

---

## 8. Troubleshooting

### ‚ùå Container kh√¥ng start

```bash
# Xem logs chi ti·∫øt
docker compose logs app

# Restart container
docker compose restart app

# N·∫øu v·∫´n l·ªói, rebuild
docker compose down
docker compose pull
docker compose up -d
```

### ‚ùå Kh√¥ng connect ƒë∆∞·ª£c database

```bash
# Ki·ªÉm tra database container
docker compose logs postgres

# Test connection t·ª´ app container
docker compose exec app bash
# Trong container:
apt update && apt install postgresql-client -y
psql -h postgres -U postgres -d evrental
# Nh·∫≠p password t·ª´ .env
```

### ‚ùå Port 8080 kh√¥ng truy c·∫≠p ƒë∆∞·ª£c

```bash
# Ki·ªÉm tra firewall
sudo ufw status

# M·ªü port 8080 (n·∫øu firewall ƒëang b·∫≠t)
sudo ufw allow 8080/tcp
sudo ufw reload

# Ki·ªÉm tra app c√≥ listen kh√¥ng
netstat -tulpn | grep 8080
```

### ‚ùå GitHub Actions failed

**Ki·ªÉm tra:**
1. GitHub Secrets ƒë√£ ƒë√∫ng ch∆∞a?
2. Server SSH c√≥ ho·∫°t ƒë·ªông kh√¥ng? (`ssh root@YOUR_IP`)
3. Xem logs chi ti·∫øt trong tab Actions

### ‚ùå Out of memory

```bash
# Ki·ªÉm tra memory
free -h

# T·∫°o swap file (n·∫øu RAM < 2GB)
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# T·ª± ƒë·ªông mount swap khi reboot
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

---

## üéØ Workflow Sau Khi Setup Xong

### Khi c√≥ code m·ªõi:

```bash
# 1. Code tr√™n local
# ... l√†m vi·ªác v·ªõi code ...

# 2. Commit v√† push
git add .
git commit -m "Add new feature"
git push origin main

# 3. GitHub Actions t·ª± ƒë·ªông:
#    ‚úÖ Build & test
#    ‚úÖ Build Docker image
#    ‚úÖ Push to Docker Hub
#    ‚úÖ Deploy to server
#    ‚úÖ Health check

# 4. Ki·ªÉm tra (sau 10-15 ph√∫t)
curl http://YOUR_SERVER_IP:8080/actuator/health
```

**XONG! Kh√¥ng c·∫ßn l√†m g√¨ th√™m! üéâ**

---

## üìû H·ªó Tr·ª£

N·∫øu g·∫∑p v·∫•n ƒë·ªÅ:

1. **Ki·ªÉm tra logs GitHub Actions** (tab Actions)
2. **Ki·ªÉm tra logs tr√™n server** (`docker compose logs`)
3. **Ch·∫°y health-check script**
4. **Xem ph·∫ßn Troubleshooting ·ªü tr√™n**

---

## üîó T√†i Li·ªáu Tham Kh·∫£o

- [Docker Documentation](https://docs.docker.com)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [DigitalOcean Tutorials](https://www.digitalocean.com/community/tutorials)
- [Docker Compose Reference](https://docs.docker.com/compose/compose-file/)

---

**Good luck! üöÄ**
